<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc -->
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>CustomObjectDocumentation</title>
<link rel="stylesheet" type="text/css" href="../../../../stylesheet.css" title="Style">
<script type="text/javascript" src="../../../../script.js"></script>
</head>
<body>
<script type="text/javascript"><!--
    try {
        if (location.href.indexOf('is-external=true') == -1) {
            parent.document.title="CustomObjectDocumentation";
        }
    }
    catch(err) {
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar.top">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.top" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.top.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../io/sphere/sdk/meta/ContributorDocumentation.html" title="class in io.sphere.sdk.meta"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../../io/sphere/sdk/meta/DocumentationGuidelines.html" title="class in io.sphere.sdk.meta"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?io/sphere/sdk/meta/CustomObjectDocumentation.html" target="_top">Frames</a></li>
<li><a href="CustomObjectDocumentation.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li><a href="#methods.inherited.from.class.java.lang.Object">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li>Method</li>
</ul>
</div>
<a name="skip.navbar.top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<!-- ======== START OF CLASS DATA ======== -->
<div class="header">
<div class="subTitle">io.sphere.sdk.meta</div>
<h2 title="Class CustomObjectDocumentation" class="title">Class CustomObjectDocumentation</h2>
</div>
<div class="contentContainer">
<ul class="inheritance">
<li>java.lang.Object</li>
<li>
<ul class="inheritance">
<li>io.sphere.sdk.meta.CustomObjectDocumentation</li>
</ul>
</li>
</ul>
<div class="description">
<ul class="blockList">
<li class="blockList">
<hr>
<br>
<pre>public final class <span class="typeNameLabel">CustomObjectDocumentation</span>
extends java.lang.Object</pre>
<div class="block"><p>Custom objects are a way to store arbitrary JSON-formatted data on the SPHERE.IO platform.
 It allows you to persist data that does not fit our standard data model.</p>

 A <a href="../../../../io/sphere/sdk/customobjects/CustomObject.html" title="interface in io.sphere.sdk.customobjects"><code>CustomObject</code></a> contains an ID, a version, timestamps
 like the other resources in SPHERE.IO and in addition <a href="../../../../io/sphere/sdk/customobjects/CustomObject.html#getContainer--"><code>CustomObject.getContainer()</code></a>,
 <a href="../../../../io/sphere/sdk/customobjects/CustomObject.html#getKey--"><code>CustomObject.getKey()</code></a> and <a href="../../../../io/sphere/sdk/customobjects/CustomObject.html#getValue--"><code>CustomObject.getValue()</code></a>.

 <p>Container and key are namespaces like in a key-value store. The value is a JSON structure
 which can hold custom domain models.</p>

 Instead of pure JSON it is encouraged to use Java objects (POJO) with the Jackson JSON mapper.

 <h3 id=pojo-mapping>Custom Objects with POJO JSON mapping</h3>

 <p>Custom objects can be used with custom Java classes and the Jackson mapper used by the SDK.</p>



 The following class contains a constructor with all field types and names a parameter for deserialization and getters for serialization.

 <div id="io-sphere-sdk-customobjects-demo-Foo%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.core.type.TypeReference;
import io.sphere.sdk.customobjects.CustomObject;
import io.sphere.sdk.models.Base;
import io.sphere.sdk.queries.PagedQueryResult;
</code></pre><pre><code class='java'>/**
 A demo class for a value of a custom object
 */
public class Foo extends Base {

    /** this custom object stores a long */
    private final long baz;
    /** this custom object stores also a String*/
    private final String bar;

    @JsonCreator
    public Foo(final String bar, final long baz) {
        this.bar = bar;
        this.baz = baz;
    }

    public String getBar() {
        return bar;
    }

    public long getBaz() {
        return baz;
    }

    public static TypeReference&lt;CustomObject&lt;Foo&gt;&gt; customObjectTypeReference() {
        return new TypeReference&lt;CustomObject&lt;Foo&gt;&gt;(){
            @Override
            public String toString() {
                return "TypeReference&lt;CustomObject&lt;" + Foo.class.getSimpleName() + "&gt;&gt;";
            }
        };
    }

    public static TypeReference&lt;PagedQueryResult&lt;CustomObject&lt;Foo&gt;&gt;&gt; pagedQueryResultTypeReference() {
        return new TypeReference&lt;PagedQueryResult&lt;CustomObject&lt;Foo&gt;&gt;&gt;(){
            @Override
            public String toString() {
                return "TypeReference&lt;PagedQueryResult&lt;CustomObject&lt;" + Foo.class.getSimpleName() + "&gt;&gt;&gt;";
            }
        };
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/demo/Foo.java" target="_blank">test code</a>.</pre></div>

 <h4 id=pojo-create-custom-objects>Create Custom Objects</h4>

 Create them with a <a href="../../../../io/sphere/sdk/customobjects/commands/CustomObjectUpsertCommand.html" title="class in io.sphere.sdk.customobjects.commands"><code>CustomObjectUpsertCommand</code></a>:

 <div id="io-sphere-sdk-customobjects-CustomObjectFixtures-createCustomObject--%s" class=code-example><pre><code class='java'>final String container = "CustomObjectFixtures";
final String key = randomKey();
final Foo value = FOO_DEFAULT_VALUE;
final TypeReference&lt;CustomObject&lt;Foo&gt;&gt; typeReference = Foo.customObjectTypeReference();
final CustomObjectDraft&lt;Foo&gt; draft = CustomObjectDraft.ofUnversionedUpsert(container, key, value, typeReference);
final CustomObjectUpsertCommand&lt;Foo&gt; createCommand = CustomObjectUpsertCommand.of(draft);
final CustomObject&lt;Foo&gt; customObject = client.execute(createCommand);
assertThat(customObject.getContainer()).isEqualTo(container);
assertThat(customObject.getKey()).isEqualTo(key);
final Foo loadedValue = customObject.getValue();
assertThat(loadedValue).isEqualTo(value);
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/CustomObjectFixtures.java" target="_blank">test code</a>.</pre></div>

 <h4 id=pojo-update-custom-objects>Update Custom Objects</h4>

In this case you use also <a href="../../../../io/sphere/sdk/customobjects/commands/CustomObjectUpsertCommand.html" title="class in io.sphere.sdk.customobjects.commands"><code>CustomObjectUpsertCommand</code></a>.

 For update operations you can use <a href="../../../../io/sphere/sdk/customobjects/CustomObjectDraft.html#ofVersionedUpdate-io.sphere.sdk.customobjects.CustomObject-T-com.fasterxml.jackson.core.type.TypeReference-"><code>CustomObjectDraft.ofVersionedUpdate(io.sphere.sdk.customobjects.CustomObject, Object, com.fasterxml.jackson.core.type.TypeReference)</code></a>
 to use optimistic concurrency control as in here:

 <div id="io-sphere-sdk-customobjects-commands-CustomObjectUpsertCommandTest-updateWithVersion--%s" class=code-example><pre><code class='java'>CustomObjectFixtures.withCustomObject(client(), customObject -&gt; {
    final TypeReference&lt;CustomObject&lt;Foo&gt;&gt; typeReference = Foo.customObjectTypeReference();
    final Foo newValue = new Foo("new value", 72);
    final CustomObjectDraft&lt;Foo&gt; draft = CustomObjectDraft.ofVersionedUpdate(customObject, newValue, typeReference);
    final CustomObjectUpsertCommand&lt;Foo&gt; command = CustomObjectUpsertCommand.of(draft);
    final CustomObject&lt;Foo&gt; updatedCustomObject = execute(command);
    final Foo loadedValue = updatedCustomObject.getValue();
    assertThat(loadedValue).isEqualTo(newValue);
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/commands/CustomObjectUpsertCommandTest.java" target="_blank">test code</a>.</pre></div>

 Or you can just override the value using <a href="../../../../io/sphere/sdk/customobjects/CustomObjectDraft.html#ofUnversionedUpdate-io.sphere.sdk.customobjects.CustomObject-T-com.fasterxml.jackson.core.type.TypeReference-"><code>CustomObjectDraft.ofUnversionedUpdate(io.sphere.sdk.customobjects.CustomObject, Object, com.fasterxml.jackson.core.type.TypeReference)</code></a>

 <div id="io-sphere-sdk-customobjects-commands-CustomObjectUpsertCommandTest-updateWithoutVersion--%s" class=code-example><pre><code class='java'>CustomObjectFixtures.withCustomObject(client(), customObject -&gt; {
    final TypeReference&lt;CustomObject&lt;Foo&gt;&gt; typeReference = Foo.customObjectTypeReference();
    final Foo newValue = new Foo("new value", 72);
    final CustomObjectDraft&lt;Foo&gt; draft = CustomObjectDraft.ofUnversionedUpdate(customObject, newValue, typeReference);
    final CustomObjectUpsertCommand&lt;Foo&gt; createCommand = CustomObjectUpsertCommand.of(draft);
    final CustomObject&lt;Foo&gt; updatedCustomObject = execute(createCommand);
    final Foo loadedValue = updatedCustomObject.getValue();
    assertThat(loadedValue).isEqualTo(newValue);
});
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/commands/CustomObjectUpsertCommandTest.java" target="_blank">test code</a>.</pre></div>

 <h3 id=pure-json-mapping>Custom objects with direct Jackson JSON</h3>

 <h4 id=direct-json-creation>Create and update custom objects</h4>

 <div id="io-sphere-sdk-customobjects-commands-CustomObjectUpsertCommandTest-pureJson--%s" class=code-example><pre><code class='java'>final ObjectMapper objectMapper = JsonUtils.newObjectMapper();//you should cache this one
final ObjectNode objectNode = objectMapper.createObjectNode()
        .put("bar", " a string")
        .put("baz", 5L);
final String key = "pure-json";
final CustomObjectUpsertCommand&lt;JsonNode&gt; command =
        CustomObjectUpsertCommand.of(CustomObjectDraft.ofUnversionedUpsert(CONTAINER, key, objectNode));
final CustomObject&lt;JsonNode&gt; customObject = execute(command);
assertThat(customObject.getValue().get("bar").asText("default value")).isEqualTo(" a string");
assertThat(customObject.getValue().get("baz").asLong(0)).isEqualTo(5);
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/commands/CustomObjectUpsertCommandTest.java" target="_blank">test code</a>.</pre></div>

 <h4 id=direct-json-fetch>Fetch custom objects</h4>

 <div id="io-sphere-sdk-customobjects-queries-CustomObjectByKeyFetchTest-executionForPureJson--%s" class=code-example><pre><code class='java'>withCustomObject(client(), existingCustomObject -&gt; {
    final String container = existingCustomObject.getContainer();
    final String key = existingCustomObject.getKey();
    final CustomObjectByKeyFetch&lt;JsonNode&gt; fetch = CustomObjectByKeyFetch.of(container, key);
    final Optional&lt;CustomObject&lt;JsonNode&gt;&gt; customObjectOptional = execute(fetch);
    assertThat(customObjectOptional).isPresent();
    final JsonNode value = customObjectOptional.get().getValue();
    final String expected = existingCustomObject.getValue().getBar();
    final String actual = value.get("bar").asText("it is not present");
    assertThat(actual).isEqualTo(expected);
});
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/queries/CustomObjectByKeyFetchTest.java" target="_blank">test code</a>.</pre></div>

 <h4 id=direct-json-query>Query custom objects</h4>

 <div id="io-sphere-sdk-customobjects-queries-CustomObjectQueryTest-queryPureJson--%s" class=code-example><pre><code class='java'>withCustomObject(client(), existingCustomObject -&gt; {
    final QuerySort&lt;CustomObject&lt;JsonNode&gt;&gt; sort = CustomObjectQueryModel.&lt;JsonNode&gt;of().createdAt().sort(DESC);
    final CustomObjectQuery&lt;JsonNode&gt; clientRequest = CustomObjectQuery.of().withSort(sort);
    final PagedQueryResult&lt;CustomObject&lt;JsonNode&gt;&gt; result = execute(clientRequest);
    assertThat(result.getResults().stream().filter(item -&gt; item.hasSameIdAs(existingCustomObject)).count())
            .isGreaterThanOrEqualTo(1);
    final String expected = existingCustomObject.getValue().getBar();
    final CustomObject&lt;JsonNode&gt; loadedCustomObject = result.head().get();
    final JsonNode jsonNode = loadedCustomObject.getValue();
    final String actual = jsonNode.get("bar").asText("it is not present");
    assertThat(actual).isEqualTo(expected);
});
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/queries/CustomObjectQueryTest.java" target="_blank">test code</a>.</pre></div>

 <h3 id=custom-json-mapper>Custom Objects with a custom JSON mapper</h3>

 <p>If you need to create your own models and you prefer another JSON tool over Jackson you can use it at your own risk.</p>
 <h4>The models for the demo</h4>
 <div id="io-sphere-sdk-customobjects-demo-GsonFooCustomObjectDraft%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'></code></pre><pre><code class='java'>public class GsonFooCustomObjectDraft {
    private final GsonFoo value;
    private final String container;
    private final String key;

    public GsonFooCustomObjectDraft(final String container, final String key, final GsonFoo value) {
        this.container = container;
        this.value = value;
        this.key = key;
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/demo/GsonFooCustomObjectDraft.java" target="_blank">test code</a>.</pre></div>
 <div id="io-sphere-sdk-customobjects-demo-GsonFoo%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import io.sphere.sdk.models.Base;
</code></pre><pre><code class='java'>public class GsonFoo extends Base {

    private final long baz;
    private final String bar;

    public GsonFoo(final String bar, final long baz) {
        this.bar = bar;
        this.baz = baz;
    }

    public String getBar() {
        return bar;
    }

    public long getBaz() {
        return baz;
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/demo/GsonFoo.java" target="_blank">test code</a>.</pre></div>

 <h4>Create and update with a custom JSON mapper</h4>
 <p>Extend <a href="../../../../io/sphere/sdk/customobjects/commands/CustomObjectCustomJsonMappingUpsertCommand.html" title="class in io.sphere.sdk.customobjects.commands"><code>CustomObjectCustomJsonMappingUpsertCommand</code></a> to create or update a custom object with <a href="https://code.google.com/p/google-gson/">Google Gson</a>:</p>

 <div id="io-sphere-sdk-customobjects-demo-GsonFooCustomObjectUpsertCommand%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.google.gson.Gson;
import io.sphere.sdk.customobjects.commands.CustomObjectCustomJsonMappingUpsertCommand;
import io.sphere.sdk.http.HttpResponse;
</code></pre><pre><code class='java'>public class GsonFooCustomObjectUpsertCommand extends CustomObjectCustomJsonMappingUpsertCommand&lt;GsonFoo&gt; {
    private final Gson gson = new Gson();
    private final GsonFooCustomObjectDraft draft;

    public GsonFooCustomObjectUpsertCommand(final GsonFooCustomObjectDraft draft) {
        this.draft = draft;
    }

    @Override
    protected String bodyAsJsonString() {
        return gson.toJson(draft);
    }

    @Override
    public GsonFooCustomObject deserialize(final HttpResponse httpResponse) {
        final String jsonAsString = getBodyAsString(httpResponse);
        return gson.fromJson(jsonAsString, GsonFooCustomObject.class);
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/demo/GsonFooCustomObjectUpsertCommand.java" target="_blank">test code</a>.</pre></div>

 <h4>Fetch by container and key</h4>

 <div id="io-sphere-sdk-customobjects-demo-GsonFooCustomObjectByKeyFetch%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.google.gson.Gson;
import io.sphere.sdk.customobjects.CustomObject;
import io.sphere.sdk.customobjects.queries.CustomObjectCustomJsonMappingByKeyFetch;
import io.sphere.sdk.http.HttpResponse;
import java.util.function.Function;
</code></pre><pre><code class='java'>public class GsonFooCustomObjectByKeyFetch extends CustomObjectCustomJsonMappingByKeyFetch&lt;GsonFoo&gt; {

    public GsonFooCustomObjectByKeyFetch(final String container, final String key) {
        super(container, key);
    }

    @Override
    protected Function&lt;HttpResponse, CustomObject&lt;GsonFoo&gt;&gt; deserializeCustomObject() {
        return httpResponse -&gt; {
            final String jsonAsString = getBodyAsString(httpResponse);
            return new Gson().fromJson(jsonAsString, GsonFooCustomObject.class);
        };
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/demo/GsonFooCustomObjectByKeyFetch.java" target="_blank">test code</a>.</pre></div>
 <div id="io-sphere-sdk-customobjects-queries-CustomObjectCustomJsonMappingByKeyFetchTest-execution--%s" class=code-example><pre><code class='java'>CustomObjectFixtures.withCustomObject(client(), co -&gt; {
    final Fetch&lt;CustomObject&lt;GsonFoo&gt;&gt; fetch = new GsonFooCustomObjectByKeyFetch(co.getContainer(), co.getKey());
    final Optional&lt;CustomObject&lt;GsonFoo&gt;&gt; customObjectOptional = execute(fetch);
    assertThat(customObjectOptional).isPresent();
    assertThat(customObjectOptional.get().toReference()).isEqualTo(co.toReference());
});
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/queries/CustomObjectCustomJsonMappingByKeyFetchTest.java" target="_blank">test code</a>.</pre></div>

 <h3 id=increment-example>Using Optimistic Concurrency Control</h3>

 <p>In this example we want to create unique readable IDs (successive numbers)
 for customers since SPHERE.IO returns IDs like 8547b810-9dad-11d1-80b4-44c04fd430c8.</p>

 The data model contains the last number and the last SPHERE.IO customer ID (just to have more than one field).

 <div id="io-sphere-sdk-customobjects-occexample-CustomerNumberCounter%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.core.type.TypeReference;
import io.sphere.sdk.customobjects.CustomObject;
import io.sphere.sdk.models.Base;
</code></pre><pre><code class='java'>public class CustomerNumberCounter extends Base {
    private final long lastUsedNumber;
    private final String customerId;

    @JsonCreator
    public CustomerNumberCounter(final long lastUsedNumber, final String customerId) {
        this.lastUsedNumber = lastUsedNumber;
        this.customerId = customerId;
    }

    public long getLastUsedNumber() {
        return lastUsedNumber;
    }

    public String getCustomerId() {
        return customerId;
    }

    public static TypeReference&lt;CustomObject&lt;CustomerNumberCounter&gt;&gt; customObjectTypeReference() {
        return new TypeReference&lt;CustomObject&lt;CustomerNumberCounter&gt;&gt;() {
        };
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/occexample/CustomerNumberCounter.java" target="_blank">test code</a>.</pre></div>

 <p>Imagine, the customer number should start at 1000, so we do the following request for the initialization of the counter:</p>

 <div id="io-sphere-sdk-customobjects-occexample-FlowTest-setupInitialValue--%s" class=code-example><pre><code class='java'>final int lastUsedNumber = 999;
final CustomerNumberCounter value = new CustomerNumberCounter(lastUsedNumber, "&lt;no name&gt;");
final int initialVersionNumber = 0;
final CustomObjectDraft&lt;CustomerNumberCounter&gt; draft = //important: it takes version as parameter
        CustomObjectDraft.ofVersionedUpsert(CONTAINER, KEY, value, initialVersionNumber, CustomerNumberCounter.customObjectTypeReference());

final Command&lt;CustomObject&lt;CustomerNumberCounter&gt;&gt; initialSettingCommand = CustomObjectUpsertCommand.of(draft);

final CustomObject&lt;CustomerNumberCounter&gt; initialCounterLoaded = execute(initialSettingCommand);
assertThat(initialCounterLoaded.getValue().getLastUsedNumber())
        .overridingErrorMessage("We have created the object")
        .isEqualTo(lastUsedNumber);
assertThat(initialCounterLoaded.getVersion())
        .overridingErrorMessage("the command increments the version number by 1")
        .isEqualTo(initialVersionNumber + 1);

try {
    execute(initialSettingCommand);
    assertThat(true).overridingErrorMessage("execute the initial command a second time will throw an exception").isFalse();
} catch (final ConcurrentModificationException e) {
    assertThat(true).overridingErrorMessage("Even in a distributed system the nodes will not override existing values with the initial value.").isTrue();
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/occexample/FlowTest.java" target="_blank">test code</a>.</pre></div>

 <p>An update works this way then:</p>
 <div id="io-sphere-sdk-customobjects-occexample-FlowTest-doAnUpdate--%s" class=code-example><pre><code class='java'>final CustomObjectByKeyFetch&lt;CustomerNumberCounter&gt; fetch =
        CustomObjectByKeyFetch.of(CONTAINER, KEY, CustomerNumberCounter.customObjectTypeReference());

final CustomObject&lt;CustomerNumberCounter&gt; loadedCustomObject = execute(fetch).get();
final long newCustomerNumber = loadedCustomObject.getValue().getLastUsedNumber() + 1;
final CustomerNumberCounter value = new CustomerNumberCounter(newCustomerNumber, "whateverid");
final long version = loadedCustomObject.getVersion();
final CustomObjectDraft&lt;CustomerNumberCounter&gt; draft = CustomObjectDraft.ofVersionedUpsert(CONTAINER, KEY, value, version, CustomerNumberCounter.customObjectTypeReference());
final CustomObjectUpsertCommand&lt;CustomerNumberCounter&gt; updateCommand = CustomObjectUpsertCommand.of(draft);
final CustomObject&lt;CustomerNumberCounter&gt; updatedCustomObject = execute(updateCommand);
assertThat(updatedCustomObject.getValue().getLastUsedNumber()).isEqualTo(newCustomerNumber);

try {
    execute(updateCommand);
    assertThat(true).overridingErrorMessage("optimistic concurrency control").isFalse();
} catch (final ConcurrentModificationException e) {
    //start again at the top
    assertThat(true).overridingErrorMessage("If other nodes have same version saved, they have to fetch again the object and use the new version number").isTrue();
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/occexample/FlowTest.java" target="_blank">test code</a>.</pre></div>

<h3 id=migrations>Migrations</h3>

 <p>Your data model in the custom objects probably will evolve and you should plan for it.</p>

 <h4 id=migrations-additional-fields>Adding fields</h4>
 For new fields you can add an <code>Optional</code> to make it obvious to callers that this value can be unset.
 <p>Before adding the field (there are already saved custom objects):</p>

 <div id="io-sphere-sdk-customobjects-migrations-version1-Xyz%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.core.type.TypeReference;
import io.sphere.sdk.customobjects.CustomObject;
import io.sphere.sdk.models.Base;
</code></pre><pre><code class='java'>public class Xyz extends Base {
    private final String foo;

    @JsonCreator
    public Xyz(final String foo) {
        this.foo = foo;
    }

    public String getFoo() {
        return foo;
    }

    public static TypeReference&lt;CustomObject&lt;Xyz&gt;&gt; customObjectTypeReference() {
        return new TypeReference&lt;CustomObject&lt;Xyz&gt;&gt;() {
            @Override
            public String toString() {
                return "TypeReference&lt;CustomObject&lt;Xyz&gt;&gt;";
            }
        };
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/version1/Xyz.java" target="_blank">test code</a>.</pre></div>

 <p>After adding the field:</p>

 <div id="io-sphere-sdk-customobjects-migrations-version2-Xyz%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.core.type.TypeReference;
import io.sphere.sdk.customobjects.CustomObject;
import io.sphere.sdk.models.Base;
import java.util.Optional;
</code></pre><pre><code class='java'>public class Xyz extends Base {
    private final String foo;
    private final Optional&lt;String&gt; bar;

    @JsonCreator
    public Xyz(final String foo, final Optional&lt;String&gt; bar) {
        this.foo = foo;
        this.bar = bar;
    }

    public String getFoo() {
        return foo;
    }

    public Optional&lt;String&gt; getBar() {
        return bar;
    }

    public static TypeReference&lt;CustomObject&lt;Xyz&gt;&gt; customObjectTypeReference() {
        return new TypeReference&lt;CustomObject&lt;Xyz&gt;&gt;() {
            @Override
            public String toString() {
                return "TypeReference&lt;CustomObject&lt;Xyz&gt;&gt;";
            }
        };
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/version2/Xyz.java" target="_blank">test code</a>.</pre></div>

 <div id="io-sphere-sdk-customobjects-migrations-CustomObjectsMigrationsTest-optionalExample--%s" class=code-example><pre><code class='java'>final io.sphere.sdk.customobjects.migrations.version2.Xyz xyz = new io.sphere.sdk.customobjects.migrations.version2.Xyz("foo", Optional.of("bar"));
final String bar = xyz.getBar().orElse("default value");
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/CustomObjectsMigrationsTest.java" target="_blank">test code</a>.</pre></div>

 <h4 id=migrations-removing-fields>Removing fields</h4>

 <p>Removing fields can be equivalent to ignoring fields.</p>

 Consider you have a class with a field "foo":

 <div id="io-sphere-sdk-customobjects-migrations-version2-Xyz%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.core.type.TypeReference;
import io.sphere.sdk.customobjects.CustomObject;
import io.sphere.sdk.models.Base;
import java.util.Optional;
</code></pre><pre><code class='java'>public class Xyz extends Base {
    private final String foo;
    private final Optional&lt;String&gt; bar;

    @JsonCreator
    public Xyz(final String foo, final Optional&lt;String&gt; bar) {
        this.foo = foo;
        this.bar = bar;
    }

    public String getFoo() {
        return foo;
    }

    public Optional&lt;String&gt; getBar() {
        return bar;
    }

    public static TypeReference&lt;CustomObject&lt;Xyz&gt;&gt; customObjectTypeReference() {
        return new TypeReference&lt;CustomObject&lt;Xyz&gt;&gt;() {
            @Override
            public String toString() {
                return "TypeReference&lt;CustomObject&lt;Xyz&gt;&gt;";
            }
        };
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/version2/Xyz.java" target="_blank">test code</a>.</pre></div>

 If you don't want to use it anymore, remove it from the JSON mapping:

 <div id="io-sphere-sdk-customobjects-migrations-version3-Xyz%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.core.type.TypeReference;
import io.sphere.sdk.customobjects.CustomObject;
import io.sphere.sdk.models.Base;
import java.util.Optional;
</code></pre><pre><code class='java'>public class Xyz extends Base {
    private final Optional&lt;String&gt; bar;

    @JsonCreator
    public Xyz(final Optional&lt;String&gt; bar) {
        this.bar = bar;
    }

    public Optional&lt;String&gt; getBar() {
        return bar;
    }

    public static TypeReference&lt;CustomObject&lt;Xyz&gt;&gt; customObjectTypeReference() {
        return new TypeReference&lt;CustomObject&lt;Xyz&gt;&gt;() {
            @Override
            public String toString() {
                return "TypeReference&lt;CustomObject&lt;Xyz&gt;&gt;";
            }
        };
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/version3/Xyz.java" target="_blank">test code</a>.</pre></div>

 Next time you'll save this object the field will be no more in the JSON.


<h4 id=migrations-moving-data>Moving data</h4>
 Suppose you have this data model:

 <div id="io-sphere-sdk-customobjects-migrations-version1-Uvw%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.core.type.TypeReference;
import io.sphere.sdk.customobjects.CustomObject;
</code></pre><pre><code class='java'>public class Uvw {
    private final String foo;
    private final String anotherField;

    @JsonCreator
    public Uvw(final String foo, final String anotherField) {
        this.foo = foo;
        this.anotherField = anotherField;
    }

    public String getFoo() {
        return foo;
    }

    public String getAnotherField() {
        return anotherField;
    }

    public static TypeReference&lt;CustomObject&lt;Uvw&gt;&gt; customObjectTypeReference(){
        return new TypeReference&lt;CustomObject&lt;Uvw&gt;&gt;(){
            @Override
            public String toString() {
                return "TypeReference&lt;CustomObject&lt;Uvw&gt;&gt;";
            }
        };
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/version1/Uvw.java" target="_blank">test code</a>.</pre></div>

 And you want to make 'foo' not a String, but an object with members 'a' and 'b'.

 <div id="io-sphere-sdk-customobjects-migrations-version2-Uvw%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
import com.fasterxml.jackson.core.type.TypeReference;
import io.sphere.sdk.customobjects.CustomObject;
</code></pre><pre><code class='java'>public class Uvw {
    private final Foo foo;
    private final String anotherField;

    public Uvw(final Foo foo, final String anotherField) {
        this.foo = foo;
        this.anotherField = anotherField;
    }

    public Foo getFoo() {
        return foo;
    }

    public String getAnotherField() {
        return anotherField;
    }

    public static TypeReference&lt;CustomObject&lt;Uvw&gt;&gt; customObjectTypeReference(){
        return new TypeReference&lt;CustomObject&lt;Uvw&gt;&gt;(){
            @Override
            public String toString() {
                return "TypeReference&lt;CustomObject&lt;Uvw&gt;&gt;";
            }
        };
    }

    public static class Foo {
        private final String a;
        private final String b;

        @JsonCreator
        public Foo(final String a, final String b) {
            this.a = a;
            this.b = b;
        }

        public String getA() {
            return a;
        }

        public String getB() {
            return b;
        }
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/version2/Uvw.java" target="_blank">test code</a>.</pre></div>

 And let's say, for simplicity you can directly migrate the String to the object by splitting the String the right way.

 A possible solution is to create an interface for that purpose:

 <div id="io-sphere-sdk-customobjects-migrations-version3-Uvw%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonSubTypes;
import com.fasterxml.jackson.annotation.JsonTypeInfo;
import com.fasterxml.jackson.core.type.TypeReference;
import io.sphere.sdk.customobjects.CustomObject;
</code></pre><pre><code class='java'>@JsonTypeInfo(
        use = JsonTypeInfo.Id.NAME,
        include = JsonTypeInfo.As.PROPERTY,
        property = "schemaVersion",
        defaultImpl = UvwSchemaVersion1.class)//here the first version is default implementation, it does not contain "schemaVersion"
@JsonSubTypes({
        @JsonSubTypes.Type(value = UvwSchemaVersion2.class, name = "2") })
public interface Uvw {
    Foo getFoo();

    String getAnotherField();

    static TypeReference&lt;CustomObject&lt;Uvw&gt;&gt; customObjectTypeReference(){
        return new TypeReference&lt;CustomObject&lt;Uvw&gt;&gt;(){
            @Override
            public String toString() {
                return "TypeReference&lt;CustomObject&lt;Uvw&gt;&gt;";
            }
        };
    }

    @JsonIgnore
    static Uvw of(final Foo foo, final String anotherField) {
        return new UvwSchemaVersion2(foo, anotherField);
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/version3/Uvw.java" target="_blank">test code</a>.</pre></div>

 For the two incarnations you create a class for each. The newest class contains all the field plus the schema version and it implements the interface:

 <div id="io-sphere-sdk-customobjects-migrations-version3-UvwSchemaVersion2%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
</code></pre><pre><code class='java'>public class UvwSchemaVersion2 implements Uvw {
    private final Foo foo;
    private final String anotherField;
    private final String schemaVersion = "2";

    @JsonCreator
    public UvwSchemaVersion2(final Foo foo, final String anotherField) {
        this.foo = foo;
        this.anotherField = anotherField;
    }

    public Foo getFoo() {
        return foo;
    }

    public String getAnotherField() {
        return anotherField;
    }

    public String getSchemaVersion() {
        return schemaVersion;
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/version3/UvwSchemaVersion2.java" target="_blank">test code</a>.</pre></div>

 The previous data model versions contain no fields but extend the most recent class. The old versions get the old data
 as constructor parameters and pass the transformed values to the constructor of the superclass.

 <div id="io-sphere-sdk-customobjects-migrations-version3-UvwSchemaVersion1%s" class=code-example><button type='button' style='display: none;' class='reveal-imports'>show/hide imports</button><pre class='hide code-example-imports'><code class='java'>import com.fasterxml.jackson.annotation.JsonCreator;
</code></pre><pre><code class='java'>public class UvwSchemaVersion1 extends UvwSchemaVersion2 implements Uvw {

    //the constructor parameter contains the the fields of the first version
    //so foo is a String
    @JsonCreator
    public UvwSchemaVersion1(final String foo, final String anotherField) {
        super(toFooObject(foo), anotherField);
    }

    private static Foo toFooObject(final String foo) {
        final String[] strings = foo.split("&amp;", 2);
        final String a = strings[0];
        final String b = strings[1];
        return new Foo(a, b);
    }
}
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/version3/UvwSchemaVersion1.java" target="_blank">test code</a>.</pre></div>

 As a result you only work with the interface making it transparent if it is an old or new version:

 <div id="io-sphere-sdk-customobjects-migrations-CustomObjectsMigrationsTest-exampleForMigrationCall--%s" class=code-example><pre><code class='java'>final CustomObjectByKeyFetch&lt;Uvw&gt; fetch = CustomObjectByKeyFetch.of("container", "key", Uvw.customObjectTypeReference());
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/migrations/CustomObjectsMigrationsTest.java" target="_blank">test code</a>.</pre></div>


 <h3 id="traps">Traps</h3>

 <p>Unlike other query models, <a href="../../../../io/sphere/sdk/customobjects/queries/CustomObjectQueryModel.html#of--"><code>CustomObjectQueryModel.of()</code></a> takes a type parameter of the result type of the custom object.
 Notice that it is necessary to explicitly declare the type when requesting the query model, as shown in the following examples:</p>
 <div id="io-sphere-sdk-customobjects-queries-CustomObjectQueryTest-demoModelTypeParameter--%s" class=code-example><pre><code class='java'>final QuerySort&lt;CustomObject&lt;JsonNode&gt;&gt; sort = CustomObjectQueryModel.&lt;JsonNode&gt;of().createdAt().sort(DESC);
final QuerySort&lt;CustomObject&lt;Foo&gt;&gt; fooSort = CustomObjectQueryModel.&lt;Foo&gt;of().createdAt().sort(DESC);
</code><p>See the <a href="https://github.com/sphereio/sphere-jvm-sdk/blob/master/sphere-models/src/it/java/io/sphere/sdk/customobjects/queries/CustomObjectQueryTest.java" target="_blank">test code</a>.</pre></div></div>
</li>
</ul>
</div>
<div class="summary">
<ul class="blockList">
<li class="blockList">
<!-- ========== METHOD SUMMARY =========== -->
<ul class="blockList">
<li class="blockList"><a name="method.summary">
<!--   -->
</a>
<h3>Method Summary</h3>
<ul class="blockList">
<li class="blockList"><a name="methods.inherited.from.class.java.lang.Object">
<!--   -->
</a>
<h3>Methods inherited from class&nbsp;java.lang.Object</h3>
<code>clone, equals, finalize, getClass, hashCode, notify, notifyAll, toString, wait, wait, wait</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<!-- ========= END OF CLASS DATA ========= -->
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar.bottom">
<!--   -->
</a>
<div class="skipNav"><a href="#skip.navbar.bottom" title="Skip navigation links">Skip navigation links</a></div>
<a name="navbar.bottom.firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../overview-summary.html">Overview</a></li>
<li><a href="package-summary.html">Package</a></li>
<li class="navBarCell1Rev">Class</li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../index-all.html">Index</a></li>
<li><a href="../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../io/sphere/sdk/meta/ContributorDocumentation.html" title="class in io.sphere.sdk.meta"><span class="typeNameLink">Prev&nbsp;Class</span></a></li>
<li><a href="../../../../io/sphere/sdk/meta/DocumentationGuidelines.html" title="class in io.sphere.sdk.meta"><span class="typeNameLink">Next&nbsp;Class</span></a></li>
</ul>
<ul class="navList">
<li><a href="../../../../index.html?io/sphere/sdk/meta/CustomObjectDocumentation.html" target="_top">Frames</a></li>
<li><a href="CustomObjectDocumentation.html" target="_top">No&nbsp;Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../allclasses-noframe.html">All&nbsp;Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<div>
<ul class="subNavList">
<li>Summary:&nbsp;</li>
<li>Nested&nbsp;|&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li><a href="#methods.inherited.from.class.java.lang.Object">Method</a></li>
</ul>
<ul class="subNavList">
<li>Detail:&nbsp;</li>
<li>Field&nbsp;|&nbsp;</li>
<li>Constr&nbsp;|&nbsp;</li>
<li>Method</li>
</ul>
</div>
<a name="skip.navbar.bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
<p class="legalCopy"><small><link rel='stylesheet' href='http://yandex.st/highlightjs/7.4/styles/default.min.css'><script src='http://yandex.st/highlightjs/7.4/highlight.min.js'></script><script>hljs.initHighlightingOnLoad();</script><style>code {font-size: 1.0em;font-family: monospace;}</style><script src='https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js'></script>
<span id='custom-javascripts'></span>
<script>var pathPrefix = $(".navList a[href$='index-all.html']").attr("href").replace("index-all.html", ""); var closingScriptTag = "</" + "script>"; 
$('#custom-javascripts').append("<script src='" + pathPrefix + "documentation-resources/javascripts/main.js'>" + closingScriptTag + "<link rel='stylesheet' href='" + pathPrefix + "documentation-resources/stylesheets/main.css'>");</script></small></p>
</body>
</html>
